{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "abe39129_f905e2d0",
        "filename": "core/java/com/android/internal/content/om/OverlayConfig.java",
        "patchSetId": 16
      },
      "lineNbr": 150,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "I think this deserves an explanation like an RRO in an APEX that is an update of an APEX in \u003cpartition\u003e is considered as belonging to that \u003cpartition\u003e.\n\nAlso, it might be useful to have a method in ParsedOverlayInfo that abstracts this.",
      "range": {
        "startLine": 148,
        "startChar": 0,
        "endLine": 150,
        "endChar": 64
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "01881a4e_13ab3963",
        "filename": "core/java/com/android/internal/content/om/OverlayConfig.java",
        "patchSetId": 16
      },
      "lineNbr": 150,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done.\n\nAdd a new method in ParsedOverlayInfo, with explanation in the comments of that method.",
      "parentUuid": "abe39129_f905e2d0",
      "range": {
        "startLine": 148,
        "startChar": 0,
        "endLine": 150,
        "endChar": 64
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b6f4276a_5f179251",
        "filename": "core/java/com/android/internal/content/om/OverlayConfig.java",
        "patchSetId": 16
      },
      "lineNbr": 299,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "This should be @Nullable",
      "range": {
        "startLine": 299,
        "startChar": 16,
        "endLine": 299,
        "endChar": 21
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4ef91f88_2a57f084",
        "filename": "core/java/com/android/internal/content/om/OverlayConfig.java",
        "patchSetId": 16
      },
      "lineNbr": 299,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b6f4276a_5f179251",
      "range": {
        "startLine": 299,
        "startChar": 16,
        "endLine": 299,
        "endChar": 21
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "78b309d6_70b886df",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 49,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "@Nullable",
      "range": {
        "startLine": 49,
        "startChar": 21,
        "endLine": 49,
        "endChar": 25
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e9449eaa_b57dd485",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 49,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "78b309d6_70b886df",
      "range": {
        "startLine": 49,
        "startChar": 21,
        "endLine": 49,
        "endChar": 25
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d522b65a_e0437b0a",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 53,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "@Nullable",
      "range": {
        "startLine": 53,
        "startChar": 16,
        "endLine": 53,
        "endChar": 20
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3d96475a_2c6b38e5",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 53,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d522b65a_e0437b0a",
      "range": {
        "startLine": 53,
        "startChar": 16,
        "endLine": 53,
        "endChar": 20
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5f2dff74_9d4e6516",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 108,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "This is not part of the contract. An APEX file name can be arbitrary.\n\nI think you need to scan /apex/\u003cname\u003e/overlay where \u003cname\u003e is from ApexManager, not from directories under /system/apex.",
      "range": {
        "startLine": 108,
        "startChar": 35,
        "endLine": 108,
        "endChar": 67
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "21e30c63_cbf46a30",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 108,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "ApexManager.java is not accessible from this package. So, I tried manually grabbing the IApexService service, which required some more allowlisting (in `core/jni/fd_utils.cpp` as well as selinux) to allow Zygote to use Binder, but then that started causing really odd binder transaction issues in unrelated services. According to smoreland@\u0027s comment in http://b/123884312#comment19 it sounds like we shouldn\u0027t be trying to directly use libbinder from early Zygote, which is when these overlays are parsed.\n\nSo, instead I found this apex-info-list file that you added in http://b/154823184 that seems to be for this exact purpose: getting apex info in Zygote.\n\nI\u0027ve updated this change to read from that instead. Please LMK if you have any other suggestion here!",
      "parentUuid": "5f2dff74_9d4e6516",
      "range": {
        "startLine": 108,
        "startChar": 35,
        "endLine": 108,
        "endChar": 67
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "594ae50c_e6021315",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 108,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-24T02:05:02Z",
      "side": 1,
      "message": "I see. So this code is executed not inside the system_server, but inside zygote. Is that correct?",
      "parentUuid": "21e30c63_cbf46a30",
      "range": {
        "startLine": 108,
        "startChar": 35,
        "endLine": 108,
        "endChar": 67
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0fb4cee5_f2995fc7",
        "filename": "core/java/com/android/internal/content/om/OverlayScanner.java",
        "patchSetId": 16
      },
      "lineNbr": 108,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-24T16:49:09Z",
      "side": 1,
      "message": "Right, there are two ways that the OverlayConfig.java constructor is used, both of which I\u0027ve updated in this change:\n\n1. From system_server, initialized with OverlayConfig::initializeSystemInstance(). It uses a \"PackageProvider\", which is just a java Consumer that is fed Packages (ParsingPackageRead) from PackageManagerService. In this change I\u0027ve updated PackageManagerService to provide OverlayConfig\u0027s \"SystemInstance\" with information about the package\u0027s preinstalled APEX location directly from ApexManager, since system_server can access ApexManager.\n\n2. From Zygote, initialized with OverlayConfig::getZygoteInstance(), early in Zygote when it is loading \"system assets shared by all applications\", in AssetManager.java::createSystemAssetsInZygoteLocked(). This \"zygote instance\" of OverlayConfig uses a simpler \"directory scanner\" OverlayScanner.java, which scans a set of predetermined directory paths (/\u003cpartition\u003e/overlay/) for RRO APKs, and filters it to only those targeting the \u0027android\u0027 package. In this change I\u0027ve updated OverlayScanner to read the apex-info-list XML to know which /apex/\u003capex\u003e/overlay paths it should read, for each preinstalled partition. I used apex-info-list because Zygote causes libbinder issues (like http://b/123884312#comment19) if it tries to access ApexManager/apexservice this early.\n\n\n\nre: apex-info-list: If Nikita or others want to keep apex-info-list a private implementation detail of apexd, should we formally enforce this with a `visiblity` tag on the apex-info-list build rule, to stop others like myself from attempting this?\nIf we do not use apex-info-list, and can\u0027t otherwise access apexservice from early Zygote, then for (2) one other naive option is to do a simple scan of all dirs in /apex/*, and treat them all as belonging to a relatively-low-priority (https://source.android.com/devices/architecture/rros#overlay-precedence) partition like /vendor.",
      "parentUuid": "594ae50c_e6021315",
      "range": {
        "startLine": 108,
        "startChar": 35,
        "endLine": 108,
        "endChar": 67
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6555ea08_83613c31",
        "filename": "services/core/java/com/android/server/pm/PackageManagerService.java",
        "patchSetId": 16
      },
      "lineNbr": 3149,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "nit: wrong indentation",
      "range": {
        "startLine": 3149,
        "startChar": 26,
        "endLine": 3149,
        "endChar": 30
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e16eae96_fea1db1e",
        "filename": "services/core/java/com/android/server/pm/PackageManagerService.java",
        "patchSetId": 16
      },
      "lineNbr": 3149,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6555ea08_83613c31",
      "range": {
        "startLine": 3149,
        "startChar": 26,
        "endLine": 3149,
        "endChar": 30
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "da0936ce_cf054ab3",
        "filename": "services/core/java/com/android/server/pm/PackageManagerService.java",
        "patchSetId": 16
      },
      "lineNbr": 3150,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-09-23T07:41:18Z",
      "side": 1,
      "message": "here as well",
      "range": {
        "startLine": 3150,
        "startChar": 26,
        "endLine": 3150,
        "endChar": 28
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ed08dc82_9818d9c5",
        "filename": "services/core/java/com/android/server/pm/PackageManagerService.java",
        "patchSetId": 16
      },
      "lineNbr": 3150,
      "author": {
        "id": 1455782
      },
      "writtenOn": "2021-09-23T21:53:26Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "da0936ce_cf054ab3",
      "range": {
        "startLine": 3150,
        "startChar": 26,
        "endLine": 3150,
        "endChar": 28
      },
      "revId": "65cbcb4913d55cc679362fe2d3e507f376e3b0e2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}