{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "3a1e314d_edf7bb89",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1725686
      },
      "writtenOn": "2021-11-09T16:28:33Z",
      "side": 1,
      "message": "LGTM. Robert, could you please have a look as well?\n\nUnit tests will be added separately. We\u0027d merge this now already and ask Amlogic to verify.",
      "revId": "332cf7859f06c9fbc30134bf31b1b3954c2c9cfd",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d30f9a38_73c5a0f6",
        "filename": "services/core/java/com/android/server/hdmi/HdmiControlService.java",
        "patchSetId": 4
      },
      "lineNbr": 637,
      "author": {
        "id": 1468761
      },
      "writtenOn": "2021-11-09T18:16:51Z",
      "side": 1,
      "message": "This causes NullPointerExceptions during HdmiCecLocalDeviceAudioSystemTest.\nmPowerManager is only set on boot phase \"PHASE_SYSTEM_SERVICES_READY\":\nhttps://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/hdmi/HdmiControlService.java;l\u003d690;drc\u003d68e23ec2e6b04483cfab37abb7ed32188a22c5fe\nAnd the test appears to never call `onBootPhase`.\n\nTo check, can `onAddressAllocated` be called before `systemReady()` on real boots?",
      "range": {
        "startLine": 637,
        "startChar": 15,
        "endLine": 637,
        "endChar": 44
      },
      "revId": "332cf7859f06c9fbc30134bf31b1b3954c2c9cfd",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6f295e47_8611191d",
        "filename": "services/core/java/com/android/server/hdmi/HdmiControlService.java",
        "patchSetId": 4
      },
      "lineNbr": 637,
      "author": {
        "id": 1068291
      },
      "writtenOn": "2021-11-12T11:58:55Z",
      "side": 1,
      "message": "onAddressAllocated is called during the HDMI service initialisation. I think since the powerManager is only available after the boot is complete, I will have to rework isQuiescentBoot(). Or I will have to move the systemAudioControlOnPowerOn (https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/hdmi/HdmiCecLocalDeviceAudioSystem.java;drc\u003dmaster;bpv\u003d0;bpt\u003d1;l\u003d285) out of the service initialisation path and into the onBootComplete tasks.",
      "parentUuid": "d30f9a38_73c5a0f6",
      "range": {
        "startLine": 637,
        "startChar": 15,
        "endLine": 637,
        "endChar": 44
      },
      "revId": "332cf7859f06c9fbc30134bf31b1b3954c2c9cfd",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4a014c41_cc4ecc80",
        "filename": "services/core/java/com/android/server/hdmi/HdmiControlService.java",
        "patchSetId": 4
      },
      "lineNbr": 637,
      "author": {
        "id": 1725686
      },
      "writtenOn": "2021-11-12T13:14:00Z",
      "side": 1,
      "message": "In theory, HdmiControlService#onAddressAllocated could be called before PowerMananager is ready, in the case where HdmiControlService is ready before PowerManager is. However, in that case we wouldn\u0027t be able to call PowerManager#wakeUp() either and wake up the device, which automatically avoids what we\u0027re trying to avoid with this change. So we might just add null checks, something like\n```\nif ((mPowerManager \u003d\u003d null || mPowerManager.isInteractive())\n                \u0026\u0026 (getContext().getSystemService(DisplayManager.class) \u003d\u003d null || getContext().getSystemService(DisplayManager.class).getDisplay(Display.DEFAULT_DISPLAY).getState()\u003d\u003d Display.STATE_OFF)){...}\n```\n\nIn reality, address allocation takes a significant amount of time, to poll all devices in the network. So I would be surprised if PowerManager isn\u0027t ready by then.\n\nAlternatively, if just for boot, I don\u0027t see an issue postponing `systemAudioControlOnPowerOn`. I would avoid doing that on every wake-up, though.\n\nRegarding the test, we can add `onBootPhase(PHASE_SYSTEM_SERVICES_READY)`, just like we already do in other tests as well (e.g. HdmiControlServiceTest.java).",
      "parentUuid": "6f295e47_8611191d",
      "range": {
        "startLine": 637,
        "startChar": 15,
        "endLine": 637,
        "endChar": 44
      },
      "revId": "332cf7859f06c9fbc30134bf31b1b3954c2c9cfd",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d39e5085_110035d2",
        "filename": "services/core/java/com/android/server/hdmi/HdmiControlService.java",
        "patchSetId": 4
      },
      "lineNbr": 637,
      "author": {
        "id": 1068291
      },
      "writtenOn": "2021-11-16T04:58:21Z",
      "side": 1,
      "message": "I\u0027ve made the change, the isQuiescentBoot() checks that power manager is not null before use.",
      "parentUuid": "4a014c41_cc4ecc80",
      "range": {
        "startLine": 637,
        "startChar": 15,
        "endLine": 637,
        "endChar": 44
      },
      "revId": "332cf7859f06c9fbc30134bf31b1b3954c2c9cfd",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}