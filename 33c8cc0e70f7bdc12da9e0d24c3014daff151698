{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "303ff678_5448d264",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-07T18:31:08Z",
      "side": 1,
      "message": "Thanks Susan! We\u0027ve been wanting to add this feature for a while, actually, so I\u0027m glad you did it.\n\nOne question: how does this work when \"Follow typing\" is also enabled? If they are zoomed in on the keyboard and type a letter, does it jump away from the keyboard to center on the textfield? That might be a weird unwanted interaction.",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fd8a3b33_5079a909",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-07T18:35:40Z",
      "side": 1,
      "message": "@danielnorman@google.com now that Android is using feature flags, do we need a feature flag for this contribution? And which branch should it go in?",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "962fda27_d3d91eec",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-08T16:49:05Z",
      "side": 1,
      "message": "Ah I\u0027m glad to hear that! :) And yes, good question -- it currently does jump away from the keyboard to center on the textfield. Were you expecting that turning on this feature turns off the follow typing feature?",
      "parentUuid": "303ff678_5448d264",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c2ce92e6_24e1b73e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-08T21:41:33Z",
      "side": 1,
      "message": "Yeah that seems like a good approach. Let me discuss with my UX team and get back to you. In any case that can probably be done in a follow-up CL.",
      "parentUuid": "962fda27_d3d91eec",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "79c29eb6_a0137e0c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-09T18:34:19Z",
      "side": 1,
      "message": "Great! Thanks :D",
      "parentUuid": "c2ce92e6_24e1b73e",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4d81f301_40714b3f",
        "filename": "services/accessibility/java/com/android/server/accessibility/AccessibilityManagerService.java",
        "patchSetId": 3
      },
      "lineNbr": 4908,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-09T18:24:22Z",
      "side": 1,
      "message": "Continuing with the deadlock suggestion, you\u0027d post to the handler so we\u0027re not holding the a11y lock by the time we call reapplyWindowMagnification()\n\n```suggestion\n        mMainHandler.post(mWindowManagerService::reapplyWindowMagnification);\n```",
      "range": {
        "startLine": 4901,
        "startChar": 7,
        "endLine": 4908,
        "endChar": 9
      },
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "51526f5f_e4b3711c",
        "filename": "services/accessibility/java/com/android/server/accessibility/AccessibilityUserState.java",
        "patchSetId": 3
      },
      "lineNbr": 711,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-07T18:31:08Z",
      "side": 1,
      "message": "Are these getter/setters ever used anywhere?",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2c934b8e_6bd2531b",
        "filename": "services/accessibility/java/com/android/server/accessibility/AccessibilityUserState.java",
        "patchSetId": 3
      },
      "lineNbr": 711,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-08T16:49:05Z",
      "side": 1,
      "message": "Yes! These are used in readMagnifyNavAndImeLocked() which I\u0027ve added in AccessibilityManagerService.java!",
      "parentUuid": "51526f5f_e4b3711c",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63c3ea90_44841118",
        "filename": "services/core/java/com/android/server/wm/AccessibilityController.java",
        "patchSetId": 3
      },
      "lineNbr": 267,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-09T18:24:22Z",
      "side": 1,
      "message": "So, Patrick brought up an interesting point, where this possibly could create deadlock:  \"I see in AccessibilityManagerService.onChange, they hold the a11y lock and call into WindowManagerService that then holds the WMS global lock which makes me a little nervous about deadlock.\"\n\nAlthough there are other parts of the code that also do this (e.g FullscreenMagnificationController.SpecAnimationBridge.setEnabled()), it would probably be safer (and faster) to avoid holding the two locks.\n\nOne way I can think of to mitigate this, is to simply iterate over all the mDisplayMagnifiers here in this function, and update their specs if they aren\u0027t null. That way you don\u0027t have to iterate over the displays in updateMagnifyNavAndImeLocked().\n\nSomething like what the AI just generated here:\n\n```suggestion\n        for (int i \u003d 0; i \u003c mDisplayMagnifiers.size(); i++) {\n            final DisplayMagnifier displayMagnifier \u003d mDisplayMagnifiers.valueAt(i);\n            if (displayMagnifier !\u003d null \u0026\u0026 displayMagnifier.isFullscreenMagnificationActivated()) {\n                final MagnificationSpec spec \u003d displayMagnifier.getMagnifiedViewport()\n                        .getMagnificationSpec();\n                if (spec !\u003d null) {\n                    setMagnificationSpec(displayMagnifier.mDisplayId, spec);\n                }\n            }\n        }\n```\n\n\nYou\u0027ll also have to post to the handler in updateMagnifyNavAndImeLocked() so you can get out of the a11yManagerService\u0027s lock... will post a separate suggestion there.",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "570db4db_cd720489",
        "filename": "services/core/java/com/android/server/wm/AccessibilityController.java",
        "patchSetId": 3
      },
      "lineNbr": 267,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-09T18:34:19Z",
      "side": 1,
      "message": "Oh great catch! This (with your other comment of the posting to handler) makes a lot of sense -- I\u0027ll test this out!",
      "parentUuid": "63c3ea90_44841118",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4ce86c21_1d751b97",
        "filename": "services/core/java/com/android/server/wm/AccessibilityController.java",
        "patchSetId": 3
      },
      "lineNbr": 267,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-09T20:34:43Z",
      "side": 1,
      "message": "Hey Tyler! Actually, I had a question -- is it a problem if we don\u0027t hold both locks? \n\n------\nI\u0027m thinking of the case where the device is running reapplyWindowMagnification(), and we toggle the MagnifyNavAndIME Secure Setting -- in that case, wouldn\u0027t shouldMagnify() return inconsistent values? \n\nAs a fix I could add a new lock that only readMagnifyNavAndImeLocked() and reapplyDisplayMagnification() use, but let me know what you think!\n\n[Also, this could depend how we cache, though right now, (in my local changes) in readMagnifyNavAndImeLocked(), which only holds the AccessibilityManagerService\u0027s lock, I make a call to update a member variable I created in WindowManagerService.] \n\n-------\nAlternatively, do you know if there are other situations where not holding A11yManagerService\u0027s mLock might create issues? \n\nFor example, onDisplayAdded() and onDisplayRemoved() use A11yManagerService\u0027s mLock when modifying the validDisplayList -- but I wanted to double check if you had any input!",
      "parentUuid": "570db4db_cd720489",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eb363b75_387d2883",
        "filename": "services/core/java/com/android/server/wm/WindowManagerInternal.java",
        "patchSetId": 3
      },
      "lineNbr": 383,
      "author": {
        "id": 2009640
      },
      "writtenOn": "2024-05-09T07:58:31Z",
      "side": 1,
      "message": "Naming WindowMagnification may cause some confusion with partial-screen mode magnification, while this method is used for fullscreen magnification. I\u0027m wondering if this could change to `reapplyDisplayMagnification` or some other wordings.",
      "fixSuggestions": [
        {
          "fixId": "352c0ef1_e3796c41",
          "description": "prompt_to_edit API",
          "replacements": [
            {
              "path": "services/core/java/com/android/server/wm/WindowManagerInternal.java",
              "range": {
                "startLine": 383,
                "startChar": 0,
                "endLine": 384,
                "endChar": 0
              },
              "replacement": "    public abstract void reapplyDisplayMagnification(int displayId);\n"
            }
          ]
        }
      ],
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "69ef01cc_5d6aaded",
        "filename": "services/core/java/com/android/server/wm/WindowManagerInternal.java",
        "patchSetId": 3
      },
      "lineNbr": 383,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-09T18:34:19Z",
      "side": 1,
      "message": "For sure! That makes sense -- I\u0027ll make that change!",
      "parentUuid": "eb363b75_387d2883",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f9b746e8_224bfc60",
        "filename": "services/core/java/com/android/server/wm/WindowState.java",
        "patchSetId": 3
      },
      "lineNbr": 5096,
      "author": {
        "id": 1135528
      },
      "writtenOn": "2024-05-07T18:31:08Z",
      "side": 1,
      "message": "You\u0027ll probably need to cache this value. Reading it every time will be expensive.",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2052d7eb_a2c41506",
        "filename": "services/core/java/com/android/server/wm/WindowState.java",
        "patchSetId": 3
      },
      "lineNbr": 5096,
      "author": {
        "id": 3307287
      },
      "writtenOn": "2024-05-08T16:49:05Z",
      "side": 1,
      "message": "Ah, good point! I\u0027ll look into this and post a revision!",
      "parentUuid": "f9b746e8_224bfc60",
      "revId": "33c8cc0e70f7bdc12da9e0d24c3014daff151698",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}