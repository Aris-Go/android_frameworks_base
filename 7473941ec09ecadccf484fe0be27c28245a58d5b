{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "f71f3ae2_dd27f926",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 8
      },
      "lineNbr": 0,
      "author": {
        "id": 1308163
      },
      "writtenOn": "2020-10-22T07:46:08Z",
      "side": 1,
      "message": "Since TH found a bug with this patch, I think it\u0027s better to also have a manual test to test it. (e.g. Establish legacy VPN and 3rd-party VPN app manually.)\nSee if there is any surprise with this patch.",
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4d5f69ce_c0438bdb",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 8
      },
      "lineNbr": 7199,
      "author": {
        "id": 1308163
      },
      "writtenOn": "2020-10-22T07:46:08Z",
      "side": 1,
      "message": "Do you want to combine these 2 blocks?\nIt looks to me that it\u0027s an unnecessary if clause because once the network brings up with CONNECTED state, these 2 if clause must be run at the same time.\nAnd after that, these 2 if condition won\u0027t be true anymore because both of networkAgent.created and networkAgent.everConnected are set to true.",
      "range": {
        "startLine": 7197,
        "startChar": 8,
        "endLine": 7199,
        "endChar": 82
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "345f2151_f632f0cd",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 411,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-10-28T15:44:12Z",
      "side": 1,
      "message": "Will it be confusing that there are multiple providers with the same ID? Perhaps this is fine because none of the providers will be registered.\n\nAlso, per comment on other CL - the ID_VPN constant might become another system API that we need to expose. It might be better to register the provider instead. Even though this code runs on the handler thread, registerNetworkProvider should be able to run without deadlocks and return a real provider ID.\n\nLooking at the CS code, the provider could be unregistered in Vpn#onUserStopped which is always called just before the VPN is deleted.\n\nRegistering/unregistering NetworkProviders like this every time a user is started or stopped will result in the NetworkProvider IDs becoming larger over time, but this seems fine because the number would only grow when a user is started, the provider ID is 32 bits. For safety in pathological (more likely, \"impossible\") cases we might want to ensure that nextNetworkProviderId skips ID_NONE.",
      "range": {
        "startLine": 411,
        "startChar": 32,
        "endLine": 411,
        "endChar": 54
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "661d9855_938c479b",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 411,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-10-29T13:42:09Z",
      "side": 1,
      "message": "It is also expensive in that CS will send all requests to this new agent which won\u0027t ever do anything with them. I agree the increase in provider IDs doesn\u0027t matter. We could also have only one provider for all VPNs.\n\nIn any case, I would prefer to do this in a separate patch if you don\u0027t mind. This one has fairly complex consequences that make it a bit harder to wrap one\u0027s head around alreadyÂ ; in case anything goes wrong I\u0027d prefer we can bisect to the patch really causing the issue.",
      "parentUuid": "345f2151_f632f0cd",
      "range": {
        "startLine": 411,
        "startChar": 32,
        "endLine": 411,
        "endChar": 54
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "06f67840_88582739",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 470,
      "author": {
        "id": 1308163
      },
      "writtenOn": "2020-10-22T07:46:08Z",
      "side": 1,
      "message": "I think it\u0027s better to clean the mNetworkAgent after unregistering.\nIt might be fixing the TH fail(CONNECTING state with non-null mNetworkAgent) when running the android.net.cts.Ikev2VpnTest.\nBut we still need to check the root cause.",
      "range": {
        "startLine": 470,
        "startChar": 20,
        "endLine": 470,
        "endChar": 47
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "28c5c2ad_a72eb2e3",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 470,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-10-28T15:44:12Z",
      "side": 1,
      "message": "+1, it seems natural to null out mNetworkAgent here.",
      "parentUuid": "06f67840_88582739",
      "range": {
        "startLine": 470,
        "startChar": 20,
        "endLine": 470,
        "endChar": 47
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e5b4a0d_884a1077",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1281,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-10-28T15:44:12Z",
      "side": 1,
      "message": "Why null this out here? It doesn\u0027t seem to make sense for the agent ever to be non-null here.\n\nIs it because updateState will complain if the agent is non-null?\n\nBut if so, doesn\u0027t that indicate that there should be cleanup code somewhere else in this file, which should set mNetworkAgent to null?",
      "range": {
        "startLine": 1281,
        "startChar": 9,
        "endLine": 1281,
        "endChar": 29
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fc485c1c_ce9698cc",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1281,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-10-29T13:42:09Z",
      "side": 1,
      "message": "It does. The best way is the way pointed out by Lucas and you and do it in l.470.",
      "parentUuid": "6e5b4a0d_884a1077",
      "range": {
        "startLine": 1281,
        "startChar": 9,
        "endLine": 1281,
        "endChar": 29
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "76a3e24c_d8919293",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1325,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-10-28T15:44:12Z",
      "side": 1,
      "message": "ISTM that we\u0027re trying to move away from using mNetworkInfo to indicate the state of this code. Can we just remove this check as well?",
      "range": {
        "startLine": 1325,
        "startChar": 8,
        "endLine": 1325,
        "endChar": 41
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ee20e192_a6e5a607",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1325,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-10-29T13:42:09Z",
      "side": 1,
      "message": "As I was fixing the issue above, I noticed this too. In fact, if the agent is currently CONNECTING, callers expect this method to still disconnect and it doesn\u0027t. I think it was in fact a bug before.\n\nDone.",
      "parentUuid": "76a3e24c_d8919293",
      "range": {
        "startLine": 1325,
        "startChar": 8,
        "endLine": 1325,
        "endChar": 41
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6a8245bd_98d874d7",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1327,
      "author": {
        "id": 1308163
      },
      "writtenOn": "2020-10-22T07:46:08Z",
      "side": 1,
      "message": "This can be removed if you clean the mNetworkAgent in updateStatee() when receiving DISCONNECTED state and mNetworkAgent is not null.",
      "range": {
        "startLine": 1327,
        "startChar": 12,
        "endLine": 1327,
        "endChar": 33
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "10c51329_1d5f47d6",
        "filename": "services/core/java/com/android/server/connectivity/Vpn.java",
        "patchSetId": 8
      },
      "lineNbr": 1327,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-10-29T13:42:09Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6a8245bd_98d874d7",
      "range": {
        "startLine": 1327,
        "startChar": 12,
        "endLine": 1327,
        "endChar": 33
      },
      "revId": "7473941ec09ecadccf484fe0be27c28245a58d5b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}