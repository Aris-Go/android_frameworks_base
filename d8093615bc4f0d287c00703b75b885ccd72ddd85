{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "239b7315_75ee984b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1137063
      },
      "writtenOn": "2022-11-22T17:22:48Z",
      "side": 1,
      "message": "\u003e When insert a U disk or sdcard, if fsck or mount takes a long time, it will take several seconds for the screen to light up\n\nThis does not make sense to me.  If the device is locked, why would fsck and mount be allowed at all?  The whole point of the onSecureKeyguardStateChanged stuff is to ensure that fscks and mounts do not happen while the device is locked.\n\nDo you mean the sdcard is inserted while the device is in the \"screen off and unlocked\" state?  But in that case, why would a call to onSecureKeyguardStateChanged be made by turning on the screen, when the device remains unlocked?",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "570a2f7f_b3040ebd",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1939396
      },
      "writtenOn": "2022-11-23T12:16:34Z",
      "side": 1,
      "message": "Yes, the above situation occurs when user 0 has been unlocked. the onKeyguardStateChanged method is called every time when the screen is lit or turned off. This is the stack\nat com.android.server.StorageManagerService.onKeyguardStateChanged(StorageManagerService.java:1405)\n\tat com.android.server.wm.ActivityTaskManagerService.lambda$setLockScreenShown$2$com-android-server-wm-ActivityTaskManagerService(ActivityTaskManagerService.java:3117)\n\tat com.android.server.wm.ActivityTaskManagerService$$ExternalSyntheticLambda18.run(D8$$SyntheticClass:-1)\n\tat android.os.Handler.handleCallback(Handler.java:942)\n\tat android.os.Handler.dispatchMessage(Handler.java:99)\n\tat android.os.Looper.loopOnce(Looper.java:210)\n\tat android.os.Looper.loop(Looper.java:299)\n\tat android.os.HandlerThread.run(HandlerThread.java:67)\n\tat com.android.server.ServiceThread.run(ServiceThread.java:46)",
      "parentUuid": "239b7315_75ee984b",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0d9a58e3_ff18db03",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1137063
      },
      "writtenOn": "2022-11-23T19:47:22Z",
      "side": 1,
      "message": "\u003e Yes, the above situation occurs when user 0 has been unlocked. the onKeyguardStateChanged method is called every time when the screen is lit or turned off.\n\nThat is not what I am seeing.  Which version of Android are you seeing this on?\n\nHere\u0027s what I tried, on the master branch:\n\n- Flash a build with StorageManagerService.onKeyguardStateChanged patched to do `Slog.i(TAG, \"onSecureKeyguardStateChanged \" + mSecureKeyguardShowing);` just after `mSecureKeyguardShowing` is set.\n- Set a PIN\n- Go to Settings \u003d\u003e Security \u003d\u003e Screen lock (gear)\n- Set \"Lock after screen timeout\" to 30 seconds\n- Disable \"Power button instantly locks\"\n\nWhile the device is unlocked, the last call to `onKeyguardStateChanged` had passed `false`, as expected.  When I turn the screen on and off while the device is unlocked, the device stays unlocked, and no further calls to `onKeyguardStateChanged` are made.  If I wait 30 seconds with the screen off, then the device is locked and\n`onKeyguardStateChanged` is called with `true`.\n\nI think that\u0027s all as expected.  vold really wants to know whether the device is locked, not whether the screen is on.\n\nSo I am wondering whether the root cause of your issue is elsewhere.  Just to confirm, you are certain that the device is unlocked when you insert the SD card?  If so, then perhaps there is/was a bug in Keyguard where `onKeyguardStateChanged` was being called when it shouldn\u0027t be.",
      "parentUuid": "570a2f7f_b3040ebd",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cb308b91_43daba8f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1939396
      },
      "writtenOn": "2022-11-24T08:25:14Z",
      "side": 1,
      "message": "I see it in Android 13\n\nSorry, I don\u0027t think I explained the issue clearly. When using a PIN, pattern, or password to lock the device, because KeyguardManager#isDeviceSecure() \u003d\u003d true, mSecureKeyguardShowing \u003d true, the SD card or U disk cannot be mounted at this time.\n\nIf the user does not set the password, mSecureKeyguardShowing \u003d false. In this case, the SD card or U disk will be mounted, and the opening of screen may be blocked when mount or fsck takes too long.",
      "parentUuid": "0d9a58e3_ff18db03",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ff4010d6_9309e5d2",
        "filename": "services/core/java/com/android/server/StorageManagerService.java",
        "patchSetId": 6
      },
      "lineNbr": 881,
      "author": {
        "id": 1137063
      },
      "writtenOn": "2022-11-22T17:17:27Z",
      "side": 1,
      "message": "Wrong indentation here.",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "28dcbd85_7e48f1fd",
        "filename": "services/core/java/com/android/server/StorageManagerService.java",
        "patchSetId": 6
      },
      "lineNbr": 881,
      "author": {
        "id": 1939396
      },
      "writtenOn": "2022-11-23T12:17:59Z",
      "side": 1,
      "message": "fixed",
      "parentUuid": "ff4010d6_9309e5d2",
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0cb3e86e_0b6763a3",
        "filename": "services/core/java/com/android/server/StorageManagerService.java",
        "patchSetId": 6
      },
      "lineNbr": 1348,
      "author": {
        "id": 1013030
      },
      "writtenOn": "2022-11-22T07:32:41Z",
      "side": 1,
      "message": "not sure whether it\u0027s safe to make this async. Eric do you know? Otherwise I will have to dig a bit deeper.",
      "range": {
        "startLine": 1346,
        "startChar": 6,
        "endLine": 1348,
        "endChar": 36
      },
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ac00b71b_6f79c04f",
        "filename": "services/core/java/com/android/server/StorageManagerService.java",
        "patchSetId": 6
      },
      "lineNbr": 1348,
      "author": {
        "id": 1137063
      },
      "writtenOn": "2022-11-22T17:17:27Z",
      "side": 1,
      "message": "I don\u0027t immediately see any problem with it.",
      "parentUuid": "0cb3e86e_0b6763a3",
      "range": {
        "startLine": 1346,
        "startChar": 6,
        "endLine": 1348,
        "endChar": 36
      },
      "revId": "d8093615bc4f0d287c00703b75b885ccd72ddd85",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}