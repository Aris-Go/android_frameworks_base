{
  "comments": [
    {
      "key": {
        "uuid": "e158d97a_64d93b7a",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 2716,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-03-16T10:48:49Z",
      "side": 1,
      "message": "Should there be a defensive copy here?",
      "range": {
        "startLine": 2716,
        "startChar": 44,
        "endLine": 2716,
        "endChar": 77
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "de6925e0_efdd6299",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 2716,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-03-17T04:40:19Z",
      "side": 1,
      "message": "It\u0027s unnecessaryÂ ; the only caller of this already makes a copy.\n\nhttps://osscs.corp.google.com/android/platform/superproject/+/master:frameworks/base/core/java/android/net/NetworkAgent.java;l\u003d642?q\u003dEVENT_NETWORK_CAPABILITIES_CHANGED\n\n(the search hit on the message name in NetworkMonitor is a red herring)\n\nAlso updateCapabilities starts by calling mixInCapabilities which makes a defensive copy first thing, though the damage would be done by that point by mutating the original : https://osscs.corp.google.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/ConnectivityService.java;l\u003d6145?q\u003dConnectivityService.java\n\n\nThat being said if you feel that it\u0027s safer, I can make that copy. For now I added comments explaining the above.",
      "parentUuid": "e158d97a_64d93b7a",
      "range": {
        "startLine": 2716,
        "startChar": 44,
        "endLine": 2716,
        "endChar": 77
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a363320_9eda11d0",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 2716,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-03-24T10:32:32Z",
      "side": 1,
      "message": "The reasoning here is similar to the other comment: someone in the same process could register a network with TRANSPORT_TEST and then mutate the original object.",
      "parentUuid": "de6925e0_efdd6299",
      "range": {
        "startLine": 2716,
        "startChar": 44,
        "endLine": 2716,
        "endChar": 77
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "95ebf1e7_4b210e69",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 5816,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-03-16T10:48:49Z",
      "side": 1,
      "message": "You should make the defensive copy of NetworkCapabilities before restricting the capabilities. Otherwise a caller in the same process could pass the check at line 5811 and then modify the NetworkCapabilities before we make the defensive copy at line 5825. Yes, anyone in this process is already privileged, but still.",
      "range": {
        "startLine": 5816,
        "startChar": 32,
        "endLine": 5816,
        "endChar": 65
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "88079bbf_b881a870",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 5816,
      "author": {
        "id": 1015428
      },
      "writtenOn": "2020-03-17T04:40:19Z",
      "side": 1,
      "message": "Done, though I think anyone sending a test network agent with some of the restricted caps had it coming when it\u0027s reset for them ðŸ˜Š\nBut sure, it would be unexpected. Done.",
      "parentUuid": "95ebf1e7_4b210e69",
      "range": {
        "startLine": 5816,
        "startChar": 32,
        "endLine": 5816,
        "endChar": 65
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bfa16b08_e32b6b73",
        "filename": "services/core/java/com/android/server/ConnectivityService.java",
        "patchSetId": 6
      },
      "lineNbr": 5816,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2020-03-24T10:32:32Z",
      "side": 1,
      "message": "The concern was actually:\n\n1. Attacker calls registerNetworkAgent with TRANSPORT_TEST.\n2. As soon as line 5788 executes, attacker mutates NetworkCapabilities (not copied) to remove TRANSPORT_TEST and set arbitrary capabilities.\n3. NetworkAgent is created with capabilities in #2 instead of with TRANSPORT_TEST.\n4. From now on, this network is a real network even though it was registered as a test network.",
      "parentUuid": "88079bbf_b881a870",
      "range": {
        "startLine": 5816,
        "startChar": 32,
        "endLine": 5816,
        "endChar": 65
      },
      "revId": "f46d89fbf41f2d7a2da8ad8ec16edfdfc5cfecc3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}