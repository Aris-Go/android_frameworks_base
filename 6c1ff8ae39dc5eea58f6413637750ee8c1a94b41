{
  "comments": [
    {
      "key": {
        "uuid": "c2742bbf_dcedebf5",
        "filename": "services/core/java/com/android/server/storage/AppFuseBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 135,
      "author": {
        "id": 1069219
      },
      "writtenOn": "2019-12-10T09:23:44Z",
      "side": 1,
      "message": "Why do you need this when you know StorageManagerService never calls addBridge() with the same mountId for multiple times?\n\nAlternatively, you can do either:\n- Just remove Preconditions.checkArgument(mScopes.indexOfKey(mountScope.mountId) \u003c 0) line, or\n- Just after the checkArgument(), insert a dummy entry (e.g. null) to mScopes, release the lock, put the real MountScope to mScopes later, or\n- Check mScopes.indexOfKey(mountScope.mountId) \u003c 0 just before calling mScopes.put() with a proper error handling to close the FD in case of failures.",
      "revId": "6c1ff8ae39dc5eea58f6413637750ee8c1a94b41",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0981331b_5225357a",
        "filename": "services/core/java/com/android/server/storage/AppFuseBridge.java",
        "patchSetId": 3
      },
      "lineNbr": 135,
      "author": {
        "id": 1102879
      },
      "writtenOn": "2019-12-10T10:21:53Z",
      "side": 1,
      "message": "Firstly, it might be the comment I added in the patchset(3) that misleads you, it should be replaced with the following:\n // With the current synchronization between the java and native code,\n // here we need to wait for add operation to finish to avoid data inconsistency\n\n------------------------------------------------\nQ: Why do you need this when you know StorageManagerService never calls addBridge() with the same mountId for multiple times?\n\nA: Because onClosed() could be invoked between `native_add_bridge(...)` and    \n`mScopes.put(mountScope.mountId, mountScope)`, see the thread model I described in a previous comment.\n\n------------------------------------------\nQ: Just remove Preconditions.checkArgument(mScopes.indexOfKey(mountScope.mountId) \u003c 0) line, or\n\nA: You are correct.\n------------------------------------------\n\nQ: ust after the checkArgument(), insert a dummy entry (e.g. null) to mScopes, release the lock, put the real MountScope to mScopes later, or Check mScopes.indexOfKey(mountScope.mountId) \u003c 0 just before calling mScopes.put() with a proper error handling to close the FD in case of failures.\n  \nA: I thought about it too, it is exactly the error handling code which I try to avoid in addBridge()",
      "parentUuid": "c2742bbf_dcedebf5",
      "revId": "6c1ff8ae39dc5eea58f6413637750ee8c1a94b41",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}