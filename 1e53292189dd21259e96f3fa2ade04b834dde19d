{
  "comments": [
    {
      "key": {
        "uuid": "d01a6509_aedb241c",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 398,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-05-20T02:50:38Z",
      "side": 1,
      "message": "Nit: I wonder if instead of putting this in the synchronized block we can just move mSystemReady to the end of the method, or close to the end of the method. In fact, ISTM that assigning mSystemReady here is very similar or identical to assigning it just after this synchronized block.\n\nThat said, you\u0027re clearly making the more correct than it was before, so maybe there is no need to do anything else.",
      "range": {
        "startLine": 398,
        "startChar": 12,
        "endLine": 398,
        "endChar": 32
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6f306f64_1cb5eefb",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 398,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-20T04:32:39Z",
      "side": 1,
      "message": "It is a bit tricky to reason about moving mSystemReady \u003d true at the end of the method not for concurrency reason but because in case this methods throws an exception, the system would behave differently.\n\nAt the moment SystemServer calls this with a try catch all that silences any error and moves forwards. If this happen the network stats is still \"ready\" but probably in an incorrect state. Moving mSystemReady might put the network stats into a different kind of incorrect state if systemReady() fails.\n\nI feel this is a bit out of scope for this change.",
      "parentUuid": "d01a6509_aedb241c",
      "range": {
        "startLine": 398,
        "startChar": 12,
        "endLine": 398,
        "endChar": 32
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f19ceb67_144bc871",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 398,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-22T00:49:29Z",
      "side": 1,
      "message": "To summarize, I prefer to keep this change at just moving \u0027mSystemReady \u003d true\u0027 inside synchronized. Marking the comment as resolved. Let me know if this is fine.",
      "parentUuid": "6f306f64_1cb5eefb",
      "range": {
        "startLine": 398,
        "startChar": 12,
        "endLine": 398,
        "endChar": 32
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "68a04f06_7593fe13",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-05-20T02:50:38Z",
      "side": 1,
      "message": "AFAICS this can never happen in current code. Suggest removing, replacing with:\n\n    if (mPollIntent !\u003d null) {\n        throw IllegalStateException(...);\n    }\n\nor, perhaps even better, moving the body of this method into systemReady so it\u0027s clear how it is sequenced with the other operations performed in that method.",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b0ab0fb_8b196dea",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-20T04:32:39Z",
      "side": 1,
      "message": "I considered moving it inside systemReady() and removing that branch, but I didn\u0027t because I saw that shutdownLocked() sets mSystemReady to false, and I was wondering if this service must support being restarted.\n\nIf yes then registerPollAlarm definitely needs to chancel the previous alarm. One could argue that cancelling the existing alarm would be better done in shutdownLocked() however, but at that point we are a bit beyond the original scope of this bug fix.",
      "parentUuid": "68a04f06_7593fe13",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d15fd7b5_e02e4c87",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-22T00:49:29Z",
      "side": 1,
      "message": "Similarly, I would prefer to keep the body of this function as is in this patch.",
      "parentUuid": "4b0ab0fb_8b196dea",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "83af6c4d_e79f3aec",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-05-22T03:09:32Z",
      "side": 1,
      "message": "SGTM. Care to upload a follow-up as well, then?",
      "parentUuid": "d15fd7b5_e02e4c87",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b8c40987_6e07a22f",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-22T04:15:41Z",
      "side": 1,
      "message": "Yes I can do further work there. In general if we now started to register networks earlier in ARC P so that it triggers races, I probably need to double check more things in this service anyway.\n\nBut I will have to focus on the R75 Chrome OS release for the next week, and then the R76 branch cut until end of month.",
      "parentUuid": "83af6c4d_e79f3aec",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2d0b111e_61b58ceb",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-05-22T06:17:20Z",
      "side": 1,
      "message": "To be clear, all I\u0027m suggesting here is that we remove this null check and move lines 514-519 to systemReady. That should only take a few minutes.",
      "parentUuid": "b8c40987_6e07a22f",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9e852e8d_5d305fd4",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1107893
      },
      "writtenOn": "2019-05-22T06:35:59Z",
      "side": 1,
      "message": "What about my previous comment on shutdownLocked() though ? shutdownLocked() might imply that systemReady() might be called a second time, in which case it is correct to expect a non-null mPollIntent.\n\nAgreed that what you are suggesting is the natural thing to do, but I am concerned it might be deceptively incorrect.",
      "parentUuid": "2d0b111e_61b58ceb",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e23ba400_bddeb705",
        "filename": "services/core/java/com/android/server/net/NetworkStatsService.java",
        "patchSetId": 5
      },
      "lineNbr": 512,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-05-22T07:00:36Z",
      "side": 1,
      "message": "I don\u0027t think this object can be reused. I think shutdownLocked only exists so that apps that call methods on shutdown don\u0027t end up running queries while the system is shutting down. AFAICS NetworkStatsService is only instantiated by SystemServer.java and systemReady is only ever called once on that instance.",
      "parentUuid": "9e852e8d_5d305fd4",
      "range": {
        "startLine": 510,
        "startChar": 0,
        "endLine": 512,
        "endChar": 9
      },
      "revId": "1e53292189dd21259e96f3fa2ade04b834dde19d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}