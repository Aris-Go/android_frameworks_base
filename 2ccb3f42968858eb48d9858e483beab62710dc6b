{
  "comments": [
    {
      "key": {
        "uuid": "3356095e_a97befbf",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "perhaps \u0027link local\u0027\n\nusually this stuff is called \u0027ipv6 link local\u0027",
      "range": {
        "startLine": 7,
        "startChar": 18,
        "endLine": 7,
        "endChar": 28
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fae1c2b6_9d3b810b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "network",
      "range": {
        "startLine": 7,
        "startChar": 47,
        "endLine": 7,
        "endChar": 54
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2452bea6_41d2bdf2",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fae1c2b6_9d3b810b",
      "range": {
        "startLine": 7,
        "startChar": 47,
        "endLine": 7,
        "endChar": 54
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fd8924d0_61dec1e8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 7,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3356095e_a97befbf",
      "range": {
        "startLine": 7,
        "startChar": 18,
        "endLine": 7,
        "endChar": 28
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ed7f689b_ce45498e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "link local ?",
      "range": {
        "startLine": 9,
        "startChar": 5,
        "endLine": 9,
        "endChar": 15
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "26782a59_5cf28fd0",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "could, or perhaps rather \u0027should\u0027",
      "range": {
        "startLine": 9,
        "startChar": 64,
        "endLine": 9,
        "endChar": 69
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8a26b930_20cd3b4f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "automatically",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4ef191d3_e4d8f390",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8a26b930_20cd3b4f",
      "range": {
        "startLine": 9,
        "startChar": 22,
        "endLine": 9,
        "endChar": 31
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2608751e_8d286f11",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "26782a59_5cf28fd0",
      "range": {
        "startLine": 9,
        "startChar": 64,
        "endLine": 9,
        "endChar": 69
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7a36a91e_f37c6188",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ed7f689b_ce45498e",
      "range": {
        "startLine": 9,
        "startChar": 5,
        "endLine": 9,
        "endChar": 15
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2e3053c9_be580def",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T01:30:15Z",
      "side": 1,
      "message": "could you clarify for me which ip route table this ends up in?\nhow does it pick the right one?",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "625f56ef_bbe83d35",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:18:24Z",
      "side": 1,
      "message": "For hotspot case:\n\nThis would be added as \"fe80::/64 dev wlan1 table local_network\" to the local_network routing table\n         \nip rules:\n\n10500:  from all iif lo oif wlan1 uidrange 0-0 lookup local_network \n14000:  from all iif lo oif wlan1 lookup local_network \n\nIf someone sends packets to fe80:: link local via wlan1, it would match rule 10400, query local_network table, then match the newly added routing.",
      "parentUuid": "2e3053c9_be580def",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dec1f485_d90598cd",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T02:19:20Z",
      "side": 1,
      "message": "For p2p case, just the interface name is changed to p2p-p2p0-X.",
      "parentUuid": "625f56ef_bbe83d35",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ddb3a4f2_1528dd9e",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T02:31:14Z",
      "side": 1,
      "message": "So it\u0027s always \u0027table local_network\u0027?\n\ndes this also trigger for cellular link? ims? wifi? usb? etc...",
      "parentUuid": "dec1f485_d90598cd",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3a14db2c_41cbea71",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T03:17:26Z",
      "side": 1,
      "message": "Yes, since link local is for local network segment only, it should also belong local_network table.\n\nFor wifi/usb/bt tethering, they all use ConnectivityManager to do tethering, this fix would also apply to them.\n\nFor celluar link/ims, they are not tethering services, they are IPv6 client purely I think.\nIPv6 client is not related to this fix.",
      "parentUuid": "ddb3a4f2_1528dd9e",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "144cfd84_4af0a6b2",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1308504
      },
      "writtenOn": "2019-03-08T03:42:14Z",
      "side": 1,
      "message": "It is not suitable to adding ipv6 link local route here. Currently, not all of tethering support ipv6 and ipv6 tethering don\u0027t support for multiple downstream. If you add link local route here.\nSee below use case: enable bt tethering first, then enable hotspot. \nYou may possible see below case in local_network table.\nfe80::/64 dev bt-pan proto static metric 1024 pref medium\nfe80::/64 dev wlan1 proto static metric 1024 pref medium\n\nThen, ipv6 tethering will broken since fe80::/64 always match bt-pan even ipv6 don\u0027t support for bt-pan.",
      "parentUuid": "3a14db2c_41cbea71",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a172bca2_f1611472",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T03:58:53Z",
      "side": 1,
      "message": "Does it also mean I cannot add this routing in p2p service if p2p does support ipv6 tethering with DHCP fully?",
      "parentUuid": "144cfd84_4af0a6b2",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "89555b65_37a64e5e",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1308504
      },
      "writtenOn": "2019-03-08T04:29:07Z",
      "side": 1,
      "message": "One proposal is separate the routing table. Create table p2p-p2p0-X and put the routing to this table. But each table need one netid, I think p2p service don\u0027t create networkAgent right ? Or we can simply blocked p2p and tethering enabled at the same time ??\n\nMaciej/Lorenzo, any better idea to support link local route for different interfaces ??",
      "parentUuid": "a172bca2_f1611472",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "df1ff086_5017c792",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-03-08T05:05:49Z",
      "side": 1,
      "message": "Should this code be moved to addInterfaceToLocalNetwork instead?",
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "373872d6_9366d5f2",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-03-08T05:05:49Z",
      "side": 1,
      "message": "It\u0027s fine to have multiple routes to fe80::/64 in the same table, as long as they are for different interfaces. Link-local addresses are scoped addresses - they are only meaningful for a specific interface.\n\nApplications that use link-load addresses must understand that they can only be used if the application explicitly specifies the interface.",
      "parentUuid": "89555b65_37a64e5e",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4ce30a4f_8e3a5543",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-03-08T05:07:08Z",
      "side": 1,
      "message": "Also, where do we delete these routes? Should we remove them in removeInterfaceFromLocalNetwork?",
      "parentUuid": "df1ff086_5017c792",
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "151d97ac_e130dd22",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T06:17:50Z",
      "side": 1,
      "message": "What Mark said is right, but not all as he mentioned.\nIf there is a \"fe80::/64\" prefix in local_network table, another entries with the same prefix cannot be added.\n\nAs a result, it would indeed break another tethering with real IPv6 support.",
      "parentUuid": "373872d6_9366d5f2",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a19b5526_f4e17462",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T06:17:50Z",
      "side": 1,
      "message": "I think a separate table as Mark mentioned could settle this link local routing once and for all.\n\nBy the way, I don\u0027t see reverse operations in untether function or disable IpServer part, but I observe that even I manually add some routing entries for wlan1(hostpot) by ip cli, they are removed automatically after turning hotspot off.\n\nIt seems that clean up is done in somewhere generically.",
      "parentUuid": "4ce30a4f_8e3a5543",
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bd71c51f_62ae2900",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1308504
      },
      "writtenOn": "2019-03-08T06:47:56Z",
      "side": 1,
      "message": "I think what Lorenzo point out is routing data should still match right routing rule if application explicitly specifies interface.\nHow to explicitly specifies interface ?? Using setsockopt with SO_BINDTODEVICE ??",
      "parentUuid": "151d97ac_e130dd22",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "013efebd_df1ea0f7",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1308504
      },
      "writtenOn": "2019-03-08T06:47:56Z",
      "side": 1,
      "message": "It rely on interface down to clear them.",
      "parentUuid": "a19b5526_f4e17462",
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6231a4bd_7517f65c",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1322948
      },
      "writtenOn": "2019-03-08T07:19:39Z",
      "side": 1,
      "message": "If we could put them in the table, what Lorenzon said is ok.\n\nHowever, the same prefix entries are allowed if they have different metric value.\nCurrently this value is no way to set.",
      "parentUuid": "bd71c51f_62ae2900",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "13a55186_f996ae06",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1000835
      },
      "writtenOn": "2019-03-08T07:19:53Z",
      "side": 1,
      "message": "Good point. I checked and to add the second route we need to clear NLM_F_EXCL. Maybe do something like this in RouteController.cpp?\n\n     uint16_t flags \u003d (action \u003d\u003d RTM_NEWROUTE) ? NETLINK_ROUTE_CREATE_FLAGS : NETLINK_REQUEST_FLAGS;\n+\n+    // Allow creating multiple link-local routes in the same table, so we can make IPv6\n+    // work on all interfaces in the local_network table.\n+    if (family \u003d\u003d AF_INET6 \u0026\u0026 IN6_IS_ADDR_LINKLOCAL(reinterpret_cast\u003cin6_addr *\u003e(rawAddr))) {\n+        flags ~\u003d NLM_EXCL;\n+    }\n+\n     int ret \u003d sendNetlinkRequest(action, flags, iov, ARRAY_SIZE(iov), nullptr);",
      "parentUuid": "013efebd_df1ea0f7",
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "beb58c6b_5b1559ec",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T07:53:26Z",
      "side": 1,
      "message": "We shouldn\u0027t need different metrics for fe80::/64 routes.\nYou can totally have multiples, although possibly need some appropriate netlink flags (I see Lorenzo mentions no EXCL flag)\n\nAlso there really is no reason not to have link local ipv6 routes.\nIt\u0027s really a bug that we don\u0027t always have them.\n\n(I think pretty much the only interfaces where we don\u0027t/shouldn\u0027t have them are lo and v4-* clat interfaces)\n\nThe only part that\u0027s confusing is exactly which table they should be in.\n(on a normal linux config they\u0027d be automatically added by the kernel to the default table, but Android\u0027s setup is significantly more complex)",
      "parentUuid": "6231a4bd_7517f65c",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9b3acdd9_02b4787f",
        "filename": "services/core/java/com/android/server/NetworkManagementService.java",
        "patchSetId": 1
      },
      "lineNbr": 1294,
      "author": {
        "id": 1003247
      },
      "writtenOn": "2019-03-08T07:56:04Z",
      "side": 1,
      "message": "no, not SO_BINDTODEVICE.  you set the ifindex in the addr struct (aka scope)\n\nhttp://man7.org/linux/man-pages/man7/ipv6.7.html\nstruct sockaddr_in6 {\n...\n               struct in6_addr sin6_addr;     /* IPv6 address */\n               uint32_t        sin6_scope_id; /* Scope ID (new in 2.4) */\n           };",
      "parentUuid": "beb58c6b_5b1559ec",
      "range": {
        "startLine": 1294,
        "startChar": 0,
        "endLine": 1294,
        "endChar": 74
      },
      "revId": "2ccb3f42968858eb48d9858e483beab62710dc6b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}